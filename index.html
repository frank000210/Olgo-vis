<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Algo Visualizer V17 (Ultimate Suite)</title>
    <style>
        /* --- Ê†∏ÂøÉÊ®£Âºè --- */
        body { font-family: "Segoe UI", sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; background: #f4f6f9; }
        .sidebar { width: 340px; padding: 20px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; gap: 15px; z-index: 20; box-shadow: 2px 0 10px rgba(0,0,0,0.1); overflow-y: auto; }
        
        input, select { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;}
        label { font-weight: bold; font-size: 0.9rem; color: #333; }
        button { width: 100%; padding: 10px; margin-top: 8px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: all 0.2s; font-size: 14px;}
        
        .btn-grey { background: #6c757d; color: white; } 
        .btn-blue { background: #0d6efd; color: white; }
        .btn-blue:disabled { background: #e9ecef; color: #999; cursor: not-allowed; }
        .btn-group { display: flex; gap: 5px; }
        .btn-green { background: #198754; color: white; flex: 1;}
        .btn-green:disabled { background: #e9ecef; color: #999; }
        .btn-orange { background: #fd7e14; color: white; flex: 1; border: 2px solid #fd7e14; }
        .btn-orange:hover { background: #e36209; }
        .btn-orange:disabled { background: #e9ecef; color: #999; border-color: #e9ecef; cursor: not-allowed; }

        #logBox { margin-top: auto; height: 150px; background: #222; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; overflow-y: auto; border-radius: 4px; min-height: 150px;}
        
        .stage { flex: 1; position: relative; overflow: auto; background: white; display: flex; justify-content: center; }
        #canvasLayer { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 1; }
        #domLayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }

        /* ÁØÄÈªû */
        .node { position: absolute; width: 40px; height: 40px; border-radius: 50%; background: white; border: 2px solid #0d6efd; color: #0d6efd; display: flex; justify-content: center; align-items: center; font-weight: bold; transform: translate(-50%, -50%); z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 13px; }
        .node.new { background: #dc3545; color: white; border-color: #dc3545; transform: translate(-50%, -50%) scale(1.1); }
        .node.scanning { background: #fff3cd; color: #000; border-color: #ffc107; transform: translate(-50%, -50%) scale(1.15); box-shadow: 0 0 15px #ffc107; z-index: 10; }
        .node.found { background: #198754; color: white; border-color: #198754; transform: translate(-50%, -50%) scale(1.2); z-index: 20; }
        .node.visited { background: #e9ecef; color: #adb5bd; border-color: #ced4da; }

        /* ÁâπÊÆäÊ®£Âºè */
        .node.square { border-radius: 4px; width: 45px; height: 40px; }
        .node.rect { border-radius: 2px; width: 60px; height: 30px; font-size: 12px; }
        
        /* È¶ôËïâÊ®πÊ®£Âºè */
        .node.banana { background: #ffe135; border-color: #d4ac0d; color: #555; border-radius: 12px; box-shadow: 2px 2px 0px #d4ac0d; }

        /* Ê®ôÁ±§ */
        .lbl { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #999; white-space: nowrap; }
        .prio-lbl { position: absolute; bottom: -15px; right: -5px; font-size: 9px; color: #666; background: #eee; padding: 1px 3px; border-radius: 3px; }
        .step-badge { position: absolute; top: -8px; left: -8px; width: 18px; height: 18px; background: #fd7e14; color: white; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; z-index: 15; animation: popIn 0.3s; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        .hidden { display: none; }
    </style>

    <script>
        // --- Core Logic (ES5) ---
        var queue = []; var struct = null; var searchStepper = null;
        function log(msg) { var b=document.getElementById('logBox'); if(b){var d=document.createElement('div');d.innerHTML='> '+msg;b.appendChild(d);b.scrollTop=b.scrollHeight;} }
        window.onerror = function(msg) { alert("Error: "+msg); return false; };

        // --- Utils ---
        function drawArrow(ctx,x1,y1,x2,y2,c,d){var h=6;var a=Math.atan2(y2-y1,x2-x1);ctx.beginPath();if(d)ctx.setLineDash([4,4]);else ctx.setLineDash([]);ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.strokeStyle=c||"#adb5bd";ctx.lineWidth=1.5;ctx.stroke();ctx.setLineDash([]);ctx.beginPath();ctx.moveTo(x2,y2);ctx.lineTo(x2-h*Math.cos(a-Math.PI/6),y2-h*Math.sin(a-Math.PI/6));ctx.lineTo(x2-h*Math.cos(a+Math.PI/6),y2-h*Math.sin(a+Math.PI/6));ctx.lineTo(x2,y2);ctx.fillStyle=c||"#adb5bd";ctx.fill();}
        function drawStepArrow(x1,y1,x2,y2){var ctx=document.getElementById('canvasLayer').getContext('2d');drawArrow(ctx,x1,y1,x2,y2,"#fd7e14",false);}
        function addBadge(id,n){var e=document.getElementById(id);if(e){var b=document.createElement('div');b.className='step-badge';b.innerText=n;e.appendChild(b);}}
        function randId(){return Math.floor(Math.random()*100000);}

        // ==========================
        //  NEW STRUCTURES (V17)
        // ==========================

        // 1. AVL Tree (Self-Balancing BST)
        function AVLTree() { this.root = null; }
        AVLTree.prototype.getHeight = function(n) { return n ? n.h : 0; };
        AVLTree.prototype.getBal = function(n) { return n ? this.getHeight(n.l) - this.getHeight(n.r) : 0; };
        AVLTree.prototype.rRot = function(y) {
            var x = y.l; var T2 = x.r;
            x.r = y; y.l = T2;
            y.h = Math.max(this.getHeight(y.l), this.getHeight(y.r)) + 1;
            x.h = Math.max(this.getHeight(x.l), this.getHeight(x.r)) + 1;
            return x;
        };
        AVLTree.prototype.lRot = function(x) {
            var y = x.r; var T2 = y.l;
            y.l = x; x.r = T2;
            x.h = Math.max(this.getHeight(x.l), this.getHeight(x.r)) + 1;
            y.h = Math.max(this.getHeight(y.l), this.getHeight(y.r)) + 1;
            return y;
        };
        AVLTree.prototype.add = function(v) {
            // Need ID generation inside insert to persist
            this.root = this._ins(this.root, v);
        };
        AVLTree.prototype._ins = function(n, v) {
            if(!n) return {val:v, l:null, r:null, h:1, id:'avl-'+randId()};
            if(v < n.val) n.l = this._ins(n.l, v);
            else if(v > n.val) n.r = this._ins(n.r, v);
            else return n; // No duplicates

            n.h = 1 + Math.max(this.getHeight(n.l), this.getHeight(n.r));
            var bal = this.getBal(n);

            // Left Left
            if(bal > 1 && v < n.l.val) return this.rRot(n);
            // Right Right
            if(bal < -1 && v > n.r.val) return this.lRot(n);
            // Left Right
            if(bal > 1 && v > n.l.val) { n.l = this.lRot(n.l); return this.rRot(n); }
            // Right Left
            if(bal < -1 && v < n.r.val) { n.r = this.rRot(n.r); return this.lRot(n); }

            return n;
        };
        // Draw logic is same as BST
        AVLTree.prototype.draw = function(last) {
            var w=document.getElementById('stage').offsetWidth; var nodes=[], lines=[];
            function trav(n,x,y,lvl) {
                nodes.push({val:n.val, x:x, y:y, id:n.id});
                var off=(w/2.5)/Math.pow(2,lvl+1);
                if(n.l){ lines.push({x1:x,y1:y,x2:x-off,y2:y+60}); trav(n.l,x-off,y+60,lvl+1); }
                if(n.r){ lines.push({x1:x,y1:y,x2:x+o,y2:y+60});   trav(n.r,x+off,y+60,lvl+1); } // typo fix: x+o -> x+off
            }
            // Fix traversal call
            function travFix(n,x,y,lvl) {
                nodes.push({val:n.val, x:x, y:y, id:n.id});
                var off=(w/2.5)/Math.pow(2,lvl+1);
                if(n.l){ lines.push({x1:x,y1:y,x2:x-off,y2:y+60}); travFix(n.l,x-off,y+60,lvl+1); }
                if(n.r){ lines.push({x1:x,y1:y,x2:x+off,y2:y+60}); travFix(n.r,x+off,y+60,lvl+1); }
            }
            if(this.root) travFix(this.root, w/2, 50, 0); renderLines(lines); renderNodes(nodes, last, 'abs');
        };
        // Search logic is same as BST
        AVLTree.prototype.createStepper = function(target) { return genericTreeStepper(this.root, target); };


        // 2. Banana Tree (3-way Min Heap)
        function BananaTree() { this.heap = []; }
        BananaTree.prototype.add = function(v) {
            this.heap.push(v);
            var i = this.heap.length - 1;
            while(i > 0) {
                var p = Math.floor((i - 1) / 3);
                if(this.heap[p] <= this.heap[i]) break;
                var t = this.heap[p]; this.heap[p] = this.heap[i]; this.heap[i] = t;
                i = p;
            }
        };
        BananaTree.prototype.draw = function(last) {
            var w = document.getElementById('stage').offsetWidth;
            var nodes = [], lines = [], arr = this.heap;
            function trav(i, x, y, lvl) {
                if(i >= arr.length) return;
                nodes.push({val:arr[i], x:x, y:y, id:'ban-'+i, type:'banana'});
                var off = (w/2.0) / Math.pow(3, lvl+1) * 1.5; 
                var c1=3*i+1, c2=3*i+2, c3=3*i+3;
                if(c1<arr.length) { lines.push({x1:x,y1:y,x2:x-off,y2:y+60}); trav(c1, x-off, y+60, lvl+1); }
                if(c2<arr.length) { lines.push({x1:x,y1:y,x2:x,y2:y+60});     trav(c2, x, y+60, lvl+1); }
                if(c3<arr.length) { lines.push({x1:x,y1:y,x2:x+off,y2:y+60}); trav(c3, x+off, y+60, lvl+1); }
            }
            trav(0, w/2, 50, 0); renderLines(lines); renderNodes(nodes, last, 'abs');
        };
        BananaTree.prototype.createStepper = function(target) {
            var i=0, arr=this.heap, step=0, finished=false, prevLoc=null;
            return { next: function() {
                if(finished) return; if(i>=arr.length){log("Not found.");finished=true;disableNext();return;}
                step++; var id='ban-'+i, el=document.getElementById(id);
                if(el){el.classList.add('scanning'); addBadge(id,step);}
                var cx=el?parseFloat(el.style.left):0, cy=el?parseFloat(el.style.top):0;
                if(prevLoc) drawStepArrow(prevLoc.x,prevLoc.y,cx,cy);
                log("Step "+step+": Scan "+arr[i]);
                if(arr[i]===target){if(el)el.classList.add('found');finished=true;disableNext();}
                else{if(el)el.classList.add('visited');prevLoc={x:cx,y:cy};i++;}
            }};
        };

        // ==========================
        //  EXISTING STRUCTURES (Compact)
        // ==========================
        
        // Sorted Array
        function SortedArray() { this.data = []; }
        SortedArray.prototype.add = function(v) { this.data.push(v); this.data.sort(function(a,b){return a-b}); };
        SortedArray.prototype.draw = function(l) { var list=[]; for(var i=0;i<this.data.length;i++) list.push({val:this.data[i], id:'idx-'+i, type:'square'}); renderNodes(list, l, 'flex'); };
        SortedArray.prototype.createStepper = function(t) { var l=0,h=this.data.length-1,s=0,th=this,f=false; return {next:function(){if(f)return;if(l>h){log("None");f=true;disableNext();return;}s++;var m=Math.floor((l+h)/2),id='idx-'+m,el=document.getElementById(id);if(el){el.classList.add('scanning');addBadge(id,s);}log("Chk "+m);if(th.data[m]===t){if(el)el.classList.add('found');f=true;disableNext();}else if(th.data[m]<t){for(var i=l;i<=m;i++)markV('idx-'+i);l=m+1;}else{for(var i=m;i<=h;i++)markV('idx-'+i);h=m-1;}}}; };

        // BST
        function BST() { this.root=null; }
        BST.prototype.add=function(v){var n={val:v,l:null,r:null,id:'bst-'+randId()};if(!this.root)this.root=n;else this._i(this.root,n);};
        BST.prototype._i=function(c,n){if(n.val<c.val){if(!c.l)c.l=n;else this._i(c.l,n);}else{if(!c.r)c.r=n;else this._i(c.r,n);}};
        BST.prototype.draw=function(l){var w=document.getElementById('stage').offsetWidth,ns=[],ls=[];function t(n,x,y,lv){ns.push({val:n.val,x:x,y:y,id:n.id});var o=(w/2.5)/Math.pow(2,lv+1);if(n.l){ls.push({x1:x,y1:y,x2:x-o,y2:y+60});t(n.l,x-o,y+60,lv+1);}if(n.r){ls.push({x1:x,y1:y,x2:x+o,y2:y+60});t(n.r,x+o,y+60,lv+1);}}if(this.root)t(this.root,w/2,50,0);renderLines(ls);renderNodes(ns,l,'abs');};
        BST.prototype.createStepper=function(tg){return genericTreeStepper(this.root,tg);};

        // MinHeap (Binary)
        function MinHeap() { this.h=[]; } MinHeap.prototype.add=function(v){this.h.push(v);this.h.sort(function(a,b){return a-b});};
        MinHeap.prototype.draw=function(l){var w=document.getElementById('stage').offsetWidth,ns=[],ls=[],a=this.h;function t(i,x,y,lv){if(i>=a.length)return;ns.push({val:a[i],x:x,y:y,id:'mh-'+i});var o=(w/2.5)/Math.pow(2,lv+1),l2=2*i+1,r2=2*i+2;if(l2<a.length){ls.push({x1:x,y1:y,x2:x-o,y2:y+60});t(l2,x-o,y+60,lv+1);}if(r2<a.length){ls.push({x1:x,y1:y,x2:x+o,y2:y+60});t(r2,x+o,y+60,lv+1);}}t(0,w/2,50,0);renderLines(ls);renderNodes(ns,l,'abs');};
        MinHeap.prototype.createStepper=function(tg){var i=0,a=this.h,s=0,f=false,pl=null;return{next:function(){if(f)return;if(i>=a.length){log("None");f=true;disableNext();return;}s++;var id='mh-'+i,el=document.getElementById(id);if(el){el.classList.add('scanning');addBadge(id,s);}var cx=el?parseFloat(el.style.left):0,cy=el?parseFloat(el.style.top):0;if(pl)drawStepArrow(pl.x,pl.y,cx,cy);log("Scan "+a[i]);if(a[i]===tg){if(el)el.classList.add('found');f=true;disableNext();}else{if(el)el.classList.add('visited');pl={x:cx,y:cy};i++;}}};};

        // Linear Structures (LL, DLL, Stack, Queue, Hash)
        function LinkedList(){this.n=[];} LinkedList.prototype.add=function(v){this.n.push({val:v,id:'ll-'+randId()});}; 
        LinkedList.prototype.draw=function(l){var ns=[],ls=[],sx=100,sy=100,g=80;for(var i=0;i<this.n.length;i++){var n=this.n[i],x=sx+i*g,y=sy;if(x>800){x=sx+(i%10)*g;y=sy+Math.floor(i/10)*100;}ns.push({val:n.val,x:x,y:y,id:n.id,type:'square'});if(i>0){var p=ns[i-1];ls.push({x1:p.x+25,y1:p.y,x2:x-25,y2:y,color:'#333'});}}renderLines(ls);renderNodes(ns,l,'abs');};
        LinkedList.prototype.createStepper=function(t){return genericLinear(this.n,t);};
        
        function DoublyLinkedList(){this.n=[];} DoublyLinkedList.prototype.add=function(v){this.n.push({val:v,id:'dll-'+randId()});};
        DoublyLinkedList.prototype.draw=function(l){var ns=[],ls=[],sx=100,sy=100,g=90;for(var i=0;i<this.n.length;i++){var n=this.n[i],x=sx+i*g,y=sy;ns.push({val:n.val,x:x,y:y,id:n.id,type:'square'});if(i>0){var p=ns[i-1];ls.push({x1:p.x+25,y1:p.y-5,x2:x-25,y2:y-5,color:'#000'});ls.push({x1:x-25,y1:y+5,x2:p.x+25,y2:p.y+5,color:'#666',dashed:true});}}renderLines(ls);renderNodes(ns,l,'abs');};
        DoublyLinkedList.prototype.createStepper=function(t){return genericLinear(this.n,t);};

        function Stack(){this.d=[];} Stack.prototype.add=function(v){this.d.push(v);};
        Stack.prototype.draw=function(l){var ns=[],cx=document.getElementById('stage').offsetWidth/2,sy=100;for(var i=0;i<this.d.length;i++)ns.push({val:this.d[i],x:cx,y:sy+(this.d.length-1-i)*50,id:'stk-'+i,type:'square'});renderLines([]);renderNodes(ns,l,'abs');};
        Stack.prototype.createStepper=function(t){var i=this.d.length-1,d=this.d,s=0,f=false,pl=null;return{next:function(){if(f)return;if(i<0){log("Empty/Not Found");f=true;disableNext();return;}s++;var id='stk-'+i,el=document.getElementById(id);if(el){el.classList.add('scanning');addBadge(id,s);}var cx=el?parseFloat(el.style.left):0,cy=el?parseFloat(el.style.top):0;if(pl)drawStepArrow(pl.x,pl.y,cx,cy);log("Pop "+d[i]);if(d[i]===t){if(el)el.classList.add('found');f=true;disableNext();}else{if(el)el.classList.add('visited');pl={x:cx,y:cy};i--;}}};};

        function Queue(){this.d=[];} Queue.prototype.add=function(v){this.d.push(v);};
        Queue.prototype.draw=function(l){var ns=[],ls=[],sx=100,sy=150;for(var i=0;i<this.d.length;i++){ns.push({val:this.d[i],x:sx+i*60,y:sy,id:'q-'+i,type:'square'});if(i>0)ls.push({x1:sx+(i-1)*60+25,y1:sy,x2:sx+i*60-25,y2:sy,color:'#ccc'});}renderLines(ls);renderNodes(ns,l,'abs');};
        Queue.prototype.createStepper=function(t){var mapped=[];for(var i=0;i<this.d.length;i++)mapped.push({val:this.d[i],id:'q-'+i}); return genericLinear(mapped,t);};

        function HashTable(){this.sz=10;this.t=new Array(10);for(var i=0;i<10;i++)this.t[i]=null;}
        HashTable.prototype.add=function(v){var idx=v%10,tr=0;while(this.t[idx]!==null&&tr<10){idx=(idx+1)%10;tr++;}if(tr<10)this.t[idx]=v;};
        HashTable.prototype.draw=function(l){var ns=[],sx=100,sy=100,g=60;for(var i=0;i<10;i++){var v=this.t[i]!==null?this.t[i]:"null",x=sx+i*g,y=sy;if(i>=5){x=sx+(i-5)*g;y=sy+100;}ns.push({val:v,x:x,y:y,id:'ht-'+i,type:'square',label:i});}renderLines([]);renderNodes(ns,l,'abs');};
        HashTable.prototype.createStepper=function(t){var sIdx=t%10,cIdx=sIdx,tr=0,s=0,f=false,pl=null,tb=this.t;return{next:function(){if(f)return;if(tr>=10){log("Full");f=true;disableNext();return;}s++;var id='ht-'+cIdx,val=tb[cIdx],el=document.getElementById(id);if(el){el.classList.add('scanning');addBadge(id,s);}var cx=el?parseFloat(el.style.left):0,cy=el?parseFloat(el.style.top):0;if(pl)drawStepArrow(pl.x,pl.y,cx,cy);log("Chk "+cIdx);if(val===t){if(el)el.classList.add('found');f=true;disableNext();}else if(val===null){log("Empty slot. Stop.");f=true;disableNext();}else{if(el)el.classList.add('visited');pl={x:cx,y:cy};cIdx=(cIdx+1)%10;tr++;}}};};

        // Research Structures (SkipList, Bloom, Treap, Trie, UF) - Simplified visual logic
        function SkipList(){this.n=[];} SkipList.prototype.add=function(v){this.n.push({val:v,h:Math.floor(Math.random()*3)+1,id:'sl-'+randId()});this.n.sort(function(a,b){return a.val-b.val;});}; 
        SkipList.prototype.draw=function(l){var ns=[],ls=[],sx=50,sy=150,g=70;ns.push({val:'H',x:sx,y:sy,id:'sl-h',type:'rect'});for(var i=0;i<this.n.length;i++){var n=this.n[i],x=sx+(i+1)*g;ns.push({val:n.val,x:x,y:sy,id:n.id,type:'square',label:'L'+n.h});ls.push({x1:(i==0?sx+30:sx+i*g+20),y1:sy,x2:x-20,y2:sy,color:'#333'});if(n.h>1)for(var h=2;h<=n.h;h++){var ly=sy-(h-1)*30;ns.push({val:n.val,x:x,y:ly,id:n.id+h,type:'rect',ghost:true});ls.push({x1:x,y1:ly+15,x2:x,y2:ly+30,color:'#ccc',dashed:true});}}renderLines(ls);renderNodes(ns,l,'abs');};
        SkipList.prototype.createStepper=function(t){return genericLinear(this.n,t);};

        function BloomFilter(){this.b=new Array(10).fill(0);} BloomFilter.prototype.add=function(v){this.b[v%10]=1;this.b[(v*7)%10]=1;};
        BloomFilter.prototype.draw=function(l){var ns=[];for(var i=0;i<10;i++)ns.push({val:this.b[i],id:'bf-'+i,type:'square',label:i,color:this.b[i]?'#e2e3e5':''});renderNodes(ns,l,'flex');};
        BloomFilter.prototype.createStepper=function(t){var h1=t%10,h2=(t*7)%10,s=0,f=false;return{next:function(){if(f)return;s++;if(s==1){var id='bf-'+h1,el=document.getElementById(id);if(el){el.classList.add('scanning');addBadge(id,1);}log("Hash1: "+h1);if(el&&el.innerText=='0'){log("0 -> Not Found");f=true;disableNext();}}else{var id='bf-'+h2,el=document.getElementById(id);if(el){el.classList.add('scanning');addBadge(id,2);}log("Hash2: "+h2);if(el&&el.innerText=='0')log("0 -> Not Found");else log("All 1 -> Probable Match");f=true;disableNext();}}};};

        function Treap(){this.root=null;} Treap.prototype.add=function(v){var n={val:v,p:Math.floor(Math.random()*99),l:null,r:null,id:'trp-'+randId()};if(!this.root)this.root=n;else this._i(this.root,n);};
        Treap.prototype._i=function(c,n){if(n.val<c.val){if(!c.l)c.l=n;else this._i(c.l,n);}else{if(!c.r)c.r=n;else this._i(c.r,n);}}; // Simplified insert (no rotate demo)
        Treap.prototype.draw=function(l){var w=document.getElementById('stage').offsetWidth,ns=[],ls=[];function t(n,x,y,lv){ns.push({val:n.val,x:x,y:y,id:n.id,prio:n.p});var o=(w/2.5)/Math.pow(2,lv+1);if(n.l){ls.push({x1:x,y1:y,x2:x-o,y2:y+60});t(n.l,x-o,y+60,lv+1);}if(n.r){ls.push({x1:x,y1:y,x2:x+o,y2:y+60});t(n.r,x+o,y+60,lv+1);}}if(this.root)t(this.root,w/2,50,0);renderLines(ls);renderNodes(ns,l,'abs');};
        Treap.prototype.createStepper=function(tg){return genericTreeStepper(this.root,tg);};

        function Trie(){this.root={c:{},id:'tr-r',val:'R'};} Trie.prototype.add=function(v){var s=v.toString(),c=this.root;for(var i=0;i<s.length;i++){var k=s[i];if(!c.c[k])c.c[k]={c:{},id:'tr-'+randId(),val:k};c=c.c[k];}c.end=true;};
        Trie.prototype.draw=function(l){var w=document.getElementById('stage').offsetWidth,ns=[],ls=[],q=[{n:this.root,x:w/2,y:50,rng:w}];ns.push({val:'R',x:w/2,y:50,id:this.root.id});while(q.length>0){var it=q.shift(),keys=Object.keys(it.n.c).sort(),rng=it.rng/Math.max(keys.length,1),sx=it.x-it.rng/2+rng/2;for(var i=0;i<keys.length;i++){var k=keys[i],ch=it.n.c[k],cx=sx+i*rng,cy=it.y+60;ns.push({val:k,x:cx,y:cy,id:ch.id,color:ch.end?'#198754':'',textColor:ch.end?'#fff':''});ls.push({x1:it.x,y1:it.y,x2:cx,y2:cy});q.push({n:ch,x:cx,y:cy,rng:rng});}}renderLines(ls);renderNodes(ns,l,'abs');};
        Trie.prototype.createStepper=function(t){var s=t.toString(),c=this.root,i=0,st=0,f=false,pl=null;return{next:function(){if(f)return;st++;if(i==0&&st==1){var el=document.getElementById(c.id);if(el){el.classList.add('scanning');addBadge(c.id,1);}var cx=el?parseFloat(el.style.left):0,cy=el?parseFloat(el.style.top):0;pl={x:cx,y:cy};return;}if(i>=s.length){if(c.end)log("Found Word");else log("Prefix match only");f=true;disableNext();return;}var k=s[i];if(c.c[k]){c=c.c[k];var el=document.getElementById(c.id);if(el){el.classList.add('scanning');addBadge(c.id,st);}var cx=el?parseFloat(el.style.left):0,cy=el?parseFloat(el.style.top):0;if(pl)drawStepArrow(pl.x,pl.y,cx,cy);pl={x:cx,y:cy};log("'"+k+"'");if(el)el.classList.add('visited');i++;if(i==s.length&&c.end){if(el)el.classList.add('found');log("Done");f=true;disableNext();}}else{log("No path");f=true;disableNext();}}};};

        function UnionFind(){this.p={};this.n=[];} UnionFind.prototype.add=function(v){this.p[v]=v;this.n.push(v);if(this.n.length>1&&Math.random()>0.3)this.p[v]=this.n[this.n.length-2];};
        UnionFind.prototype.draw=function(l){var ns=[];for(var i=0;i<this.n.length;i++){var v=this.n[i],p=this.p[v],x=100+(i%4)*80,y=100+Math.floor(i/4)*80;if(p!==v)y+=50;ns.push({val:v,x:x,y:y,id:'uf-'+v});}setTimeout(function(){var ctx=document.getElementById('canvasLayer').getContext('2d');ctx.clearRect(0,0,9999,9999);for(var i=0;i<ns.length;i++){var n=ns[i],pv=this.p[n.val];if(pv!==n.val){var pn=ns.filter(function(x){return x.val==pv})[0];if(pn)drawArrow(ctx,n.x,n.y,pn.x,pn.y,"#333");}}}.bind(this),10);renderNodes(ns,l,'abs');};
        UnionFind.prototype.createStepper=function(t){var c=t,s=0,f=false,pl=null,th=this;return{next:function(){if(f)return;if(th.n.indexOf(t)===-1){log("No Node");f=true;disableNext();return;}s++;var id='uf-'+c,el=document.getElementById(id);if(el){el.classList.add('scanning');addBadge(id,s);}var cx=el?parseFloat(el.style.left):0,cy=el?parseFloat(el.style.top):0;if(pl)drawStepArrow(pl.x,pl.y,cx,cy);pl={x:cx,y:cy};if(th.p[c]===c){log("Root "+c);if(el)el.classList.add('found');f=true;disableNext();}else{log(c+"->"+th.p[c]);if(el)el.classList.add('visited');c=th.p[c];}}};};

        // --- Shared Helper ---
        function genericLinear(n,t){var i=0,s=0,f=false,pl=null;return{next:function(){if(f)return;if(i>=n.length){log("End");f=true;disableNext();return;}s++;var d=n[i],id=d.id,el=document.getElementById(id);if(el){el.classList.add('scanning');addBadge(id,s);}var cx=el?parseFloat(el.style.left):0,cy=el?parseFloat(el.style.top):0;if(pl)drawStepArrow(pl.x,pl.y,cx,cy);log(d.val);if(d.val===t){if(el)el.classList.add('found');f=true;disableNext();}else{if(el)el.classList.add('visited');pl={x:cx,y:cy};i++;}}};}
        function genericTreeStepper(r,tg){var c=r,s=0,f=false,pl=null;return{next:function(){if(f)return;if(!c){log("End");f=true;disableNext();return;}s++;var el=document.getElementById(c.id);if(el){el.classList.add('scanning');addBadge(c.id,s);}var cx=el?parseFloat(el.style.left):0,cy=el?parseFloat(el.style.top):0;if(pl)drawStepArrow(pl.x,pl.y,cx,cy);log("Visit "+c.val);if(c.val===tg){if(el)el.classList.add('found');f=true;disableNext();}else{if(el)el.classList.add('visited');pl={x:cx,y:cy};if(tg<c.val)c=c.l;else c=c.r;}}};}

        // --- Render ---
        function renderLines(ls){var cvs=document.getElementById('canvasLayer'),box=document.getElementById('stage');cvs.width=box.offsetWidth;cvs.height=Math.max(box.offsetHeight,800);var ctx=cvs.getContext('2d');ctx.clearRect(0,0,9999,9999);for(var i=0;i<ls.length;i++)drawArrow(ctx,ls[i].x1,ls[i].y1,ls[i].x2,ls[i].y2,ls[i].color,ls[i].dashed);}
        function renderNodes(list,last,mode){var lay=document.getElementById('domLayer');lay.innerHTML='';lay.className=mode==='flex'?'flex-wrap':'';if(mode==='flex'){lay.style.display='flex';lay.style.gap='10px';lay.style.padding='50px';}else{lay.style.display='block';lay.style.padding='0';}for(var i=0;i<list.length;i++){var n=list[i],d=document.createElement('div');d.className='node';if(n.type)d.className+=' '+n.type;if(n.val===last)d.className+=' new';if(n.ghost)d.style.opacity='0.5';if(n.color)d.style.background=n.color;if(n.textColor)d.style.color=n.textColor;d.innerText=n.val;if(n.id)d.id=n.id;if(mode==='abs'){d.style.left=n.x+'px';d.style.top=n.y+'px';}if(n.label){var l=document.createElement('div');l.className='lbl';l.innerText=n.label;d.appendChild(l);}if(n.prio){var p=document.createElement('div');p.className='prio-lbl';p.innerText='P:'+n.prio;d.appendChild(p);}lay.appendChild(d);}}
        function markV(id){var e=document.getElementById(id);if(e)e.classList.add('visited');}
        function disableNext(){document.getElementById('btnStep').disabled=true;document.getElementById('btnStartSearch').disabled=false;}

        // --- Controller ---
        window.initSequence = function() {
            var raw=document.getElementById('inpVal').value;
            queue=[]; var parts=raw.split(',');
            for(var i=0;i<parts.length;i++){var x=parseFloat(parts[i]);if(!isNaN(x))queue.push(x);}
            if(queue.length===0){alert('Invalid');return;}
            
            var type=document.getElementById('selAlgo').value;
            if(type==='avl') struct=new AVLTree();
            else if(type==='banana') struct=new BananaTree();
            else if(type==='arr') struct=new SortedArray();
            else if(type==='bst') struct=new BST();
            else if(type==='heap') struct=new MinHeap();
            else if(type==='ll') struct=new LinkedList();
            else if(type==='dll') struct=new DoublyLinkedList();
            else if(type==='stk') struct=new Stack();
            else if(type==='q') struct=new Queue();
            else if(type==='ht') struct=new HashTable();
            else if(type==='skip') struct=new SkipList();
            else if(type==='bloom') struct=new BloomFilter();
            else if(type==='treap') struct=new Treap();
            else if(type==='trie') struct=new Trie();
            else if(type==='uf') struct=new UnionFind();

            document.getElementById('domLayer').innerHTML='';
            var cvs=document.getElementById('canvasLayer');
            cvs.getContext('2d').clearRect(0,0,9999,9999);

            document.getElementById('btnNext').disabled=false;
            document.getElementById('btnNext').innerText="ÊèíÂÖ•‰∏ã‰∏ÄÂÄã";
            document.getElementById('panelSearch').style.display='none';
            log('Reset: '+type);
        };
        window.nextInsert=function(){if(!struct||queue.length===0)return;var v=queue.shift();struct.add(v);struct.draw(v);log('Inserted: '+v);if(queue.length===0){document.getElementById('btnNext').disabled=true;document.getElementById('btnNext').innerText="Done";document.getElementById('panelSearch').style.display='block';}};
        window.startSearchMode=function(){var v=parseFloat(document.getElementById('inpSearch').value);if(isNaN(v))return;struct.draw(null);searchStepper=struct.createStepper(v);document.getElementById('btnStartSearch').disabled=true;document.getElementById('btnStep').disabled=false;log('Search '+v);};
        window.doNextStep=function(){if(searchStepper)searchStepper.next();};
        window.onload=function(){log("V17 Ultimate Ready.");};
    </script>
</head>
<body>
<div class="sidebar">
    <h2>DS Visualizer V17</h2>
    <div id="panelInsert">
        <label>1. ÈÅ∏ÊìáË≥áÊñôÁµêÊßã (15Á®Æ)</label>
        <select id="selAlgo">
            <optgroup label="Advanced Tree">
                <option value="avl">üå≤ AVL Tree (Self-Balancing)</option>
                <option value="banana">üçå Banana Tree (3-way Heap)</option>
                <option value="bst">Binary Search Tree</option>
                <option value="treap">Treap (Randomized)</option>
                <option value="trie">Trie (Prefix Tree)</option>
            </optgroup>
            <optgroup label="Linear / Basic">
                <option value="arr">Sorted Array</option>
                <option value="ll">Linked List</option>
                <option value="dll">Doubly Linked List</option>
                <option value="stk">Stack</option>
                <option value="q">Queue</option>
            </optgroup>
            <optgroup label="Hashing / Set">
                <option value="ht">Hash Table</option>
                <option value="bloom">Bloom Filter</option>
                <option value="uf">Union Find</option>
            </optgroup>
            <optgroup label="Other">
                <option value="heap">Min Heap</option>
                <option value="skip">Skip List</option>
            </optgroup>
        </select>
        <label>2. Ëº∏ÂÖ•Êï∏Êìö</label>
        <input type="text" id="inpVal" value="45, 12, 88, 5, 23, 67, 50, 99">
        <button onclick="initSequence()" class="btn-grey">ÈáçÁΩÆ (Reset)</button>
        <button onclick="nextInsert()" id="btnNext" class="btn-blue" disabled>ÊèíÂÖ•‰∏ã‰∏ÄÂÄã</button>
    </div>
    <div id="panelSearch" class="hidden">
        <hr>
        <label style="color:#0d6efd">3. ÊêúÂ∞ãÊºîÁ§∫ (ÊâãÂãïÊ≠•ÈÄ≤)</label>
        <input type="number" id="inpSearch" placeholder="Ëº∏ÂÖ•Êï∏Â≠ó...">
        <div class="btn-group" style="margin-top:10px;">
            <button onclick="startSearchMode()" id="btnStartSearch" class="btn-green">ÈñãÂßã</button>
            <button onclick="doNextStep()" id="btnStep" class="btn-orange" disabled>‰∏ã‰∏ÄÊ≠• >></button>
        </div>
        <div style="font-size:11px; color:#666; margin-top:5px;">Follow the orange arrows.</div>
    </div>
    <div id="logBox">Waiting...</div>
</div>
<div class="stage" id="stage">
    <canvas id="canvasLayer"></canvas>
    <div id="domLayer"></div>
</div>
</body>
</html>
